<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Patching HTML</title>
		<style>
			.hello {
				color: red;
			}

			.bye {
				color: blue;
			}
		</style>
	</head>
	<body>
		<div id="root"></div>
		<script type="module">
			import {
				measureName,
				measureMemory,
				afterFrameAsync,
				mutateAndLayoutAsync,
				sleep,
				raf
			} from './util.js';
			import { createRoot, createElement as h } from 'framework';

			const state = {
				msg: 'hello',
				list: new Array(1000).fill(0).map((_, i) => ({
					i,
					text: 'foobar' + i
				}))
			};

			let counter = 0;
			function App() {
				return h(
					'div',
					{ id: 'app' },
					h('p', null, '> ', ++counter, ' <'),
					h('p', null, state.msg),
					...state.list.map((obj, i) =>
						h(
							'div',
							{ key: i, title: state.msg + i },
							h('span', { className: state.msg }, obj.text),
							h('span', { className: 'baz' }, 'one'),
							h('span', { className: 'qux' }, 'two'),
							h(
								'div',
								null,
								h('span', { className: 'qux' }, 'three'),
								h('span', { className: 'qux' }, 'four'),
								h('span', { className: 'baz' }, 'five'),
								h(
									'div',
									null,
									h('span', { className: 'qux' }, 'six'),
									h('span', { className: 'baz' }, 'seven'),
									h('span', { className: state.msg }, 'eight')
								)
							)
						)
					)
				);
			}

			const root = createRoot(document.getElementById('root'));

			// const p = performance.now();
			root.render(h(App));
			// console.log(`mount: ${(performance.now() - p).toFixed(2)}ms`);

			// const patchResults = [];

			function runPatch() {
				// const s = performance.now();
				state.msg = state.msg === 'hello' ? 'bye' : 'hello';
				state.list[0].text = state.msg;
				root.render(h(App));
				// patchResults.push(performance.now() - s);
			}

			(async () => {
				for (let i = 3; i--; ) {
					await mutateAndLayoutAsync(runPatch, 11);
				}

				await sleep(100);

				await mutateAndLayoutAsync(iteration => {
					if (iteration === 0) performance.mark('start');
					runPatch();
				}, 21);
				performance.mark('stop');
				performance.measure(measureName, 'start', 'stop');

				await raf();
				measureMemory();
			})();
		</script>
	</body>
</html>
